<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Smart Water Monitoring System</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js"></script>
  <script type="module" src="https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js"></script>
  <style>
    :root {
      --bg-color: #f8f9fa;
      --text-color: #212529;
      --primary-color: #007bff;
      --header-bg: #0d6efd;
    }
    [data-theme="dark"] {
      --bg-color: #1c1f2e;
      --text-color: #f8f9fa;
      --primary-color: #0dcaf0;
      --header-bg: #1f2633;
    }
    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      transition: background-color 0.3s, color 0.3s;
    }
    .navbar, .card-header {
      background-color: var(--header-bg);
      color: white;
    }
    .card {
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 1rem;
    }
    .form-section {
      max-width: 500px;
      margin: 2rem auto;
    }
    .dashboard {
      display: none;
    }
    .chart-container {
      position: relative;
      height: 300px;
    }
  </style>
</head>
<body data-theme="light">

<nav class="navbar navbar-expand-lg navbar-dark">
  <div class="container-fluid">
    <span class="navbar-brand">Smart Water Monitoring</span>
    <div>
      <button class="btn btn-outline-light btn-sm" onclick="toggleTheme()">ðŸŒ“ Toggle Theme</button>
      <button class="btn btn-outline-warning btn-sm d-none" id="logoutBtn" onclick="logoutUser()">Logout</button>
    </div>
  </div>
</nav>

<div class="container mt-4">
  <div class="form-section" id="signupSection">
    <h3 class="text-center">Sign Up</h3>
    <div class="mb-3">
      <label for="signupEmail" class="form-label">Email</label>
      <input type="email" class="form-control" id="signupEmail">
    </div>
    <div class="mb-3">
      <label for="signupPassword" class="form-label">Password</label>
      <input type="password" class="form-control" id="signupPassword">
    </div>
    <button class="btn btn-primary w-100" onclick="signUpUser()">Create Account</button>
    <p class="text-center mt-3">Already have an account? <a href="#" onclick="showLogin()">Log in</a></p>
  </div>

  <div class="form-section" id="loginSection">
    <h3 class="text-center">Login</h3>
    <div class="mb-3">
      <label for="loginEmail" class="form-label">Email</label>
      <input type="email" class="form-control" id="loginEmail">
    </div>
    <div class="mb-3">
      <label for="loginPassword" class="form-label">Password</label>
      <input type="password" class="form-control" id="loginPassword">
    </div>
    <button class="btn btn-success w-100" onclick="loginUser()">Sign In</button>
    <p class="text-center mt-3">Don't have an account? <a href="#" onclick="showSignup()">Sign up</a></p>
  </div>

  <div class="dashboard" id="dashboardSection">
    <h3 class="text-center mb-4">Welcome, <span id="userDisplay"></span></h3>

    <div class="row">
      <div class="col-md-4">
        <div class="card text-center">
          <div class="card-header">Water Level</div>
          <div class="card-body">
            <h4 id="waterLevel">0%</h4>
            <p>Status: <strong id="tankStatus">-</strong></p>
            <p>Last Update: <span id="lastUpdated">--:--</span></p>
          </div>
        </div>
      </div>
      <div class="col-md-8">
        <div class="card">
          <div class="card-header">Live Water Level</div>
          <div class="card-body chart-container">
            <canvas id="levelChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-header">Weekly Water Usage</div>
      <div class="card-body chart-container">
        <canvas id="usageChart"></canvas>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
  import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDJMq0OwWS_OvKxnI-E_hz0R9w71O50a5U",
    authDomain: "water-lever-monitoring-system.firebaseapp.com",
    databaseURL: "https://water-lever-monitoring-system-default-rtdb.firebaseio.com",
    projectId: "water-lever-monitoring-system",
    storageBucket: "water-lever-monitoring-system.appspot.com",
    messagingSenderId: "50485783446",
    appId: "1:50485783446:web:f2510c845c0e3a4b480bb7"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth();
  const db = getDatabase();

  window.toggleTheme = () => {
    const theme = document.body.getAttribute("data-theme");
    document.body.setAttribute("data-theme", theme === "light" ? "dark" : "light");
  };

  window.showLogin = () => {
    document.getElementById("signupSection").style.display = 'none';
    document.getElementById("loginSection").style.display = 'block';
  };

  window.showSignup = () => {
    document.getElementById("loginSection").style.display = 'none';
    document.getElementById("signupSection").style.display = 'block';
  };

  window.signUpUser = () => {
    const email = document.getElementById("signupEmail").value.trim();
    const password = document.getElementById("signupPassword").value.trim();
    createUserWithEmailAndPassword(auth, email, password)
      .then(() => alert("Account created successfully!"))
      .catch(err => alert(err.message));
  };

  window.loginUser = () => {
    const email = document.getElementById("loginEmail").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    signInWithEmailAndPassword(auth, email, password)
      .catch(err => alert("Login failed: " + err.message));
  };

  window.logoutUser = () => {
    signOut(auth);
  };

  function initializeDashboard(user) {
    document.getElementById("dashboardSection").style.display = 'block';
    document.getElementById("loginSection").style.display = 'none';
    document.getElementById("signupSection").style.display = 'none';
    document.getElementById("userDisplay").textContent = user.email;
    document.getElementById("logoutBtn").classList.remove("d-none");

    const chartLabels = [];
    const chartData = [];
    const ctx1 = document.getElementById("levelChart").getContext("2d");
    const ctx2 = document.getElementById("usageChart").getContext("2d");

    const levelChart = new Chart(ctx1, {
      type: 'line',
      data: {
        labels: chartLabels,
        datasets: [{
          label: 'Water Level (%)',
          data: chartData,
          borderColor: '#0d6efd',
          backgroundColor: 'rgba(13,110,253,0.2)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { min: 0, max: 100, title: { display: true, text: "Level (%)" } },
          x: { title: { display: true, text: "Time" } }
        }
      }
    });

    new Chart(ctx2, {
      type: 'bar',
      data: {
        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'],
        datasets: [{
          label: 'Liters Used',
          data: [150, 180, 100, 130, 90],
          backgroundColor: '#0d6efd'
        }]
      },
      options: {
        responsive: true,
        plugins: { title: { display: true, text: 'Weekly Water Usage' } }
      }
    });

    const dataRef = ref(db, 'waterLevel');
    onValue(dataRef, snapshot => {
      const level = snapshot.val();
      const time = new Date().toLocaleTimeString();
      document.getElementById("waterLevel").textContent = `${level}%`;
      document.getElementById("lastUpdated").textContent = time;
      document.getElementById("tankStatus").textContent = level > 75 ? 'Full' : (level > 40 ? 'Medium' : (level > 10 ? 'Low' : 'Empty'));
      if (chartLabels.length >= 10) {
        chartLabels.shift();
        chartData.shift();
      }
      chartLabels.push(time);
      chartData.push(level);
      levelChart.update();
    });
  }

  onAuthStateChanged(auth, user => {
    if (user) {
      initializeDashboard(user);
    } else {
      document.getElementById("dashboardSection").style.display = 'none';
      document.getElementById("logoutBtn").classList.add("d-none");
      showLogin();
    }
  });
</script>

</body>
</html>
